FROM node:lts-bookworm

# Install runtime dependencies (including build tools for native bindings and xvfb for OpenGL)
RUN apt-get update -y \
  && apt-get -y install \
    ffmpeg \
    build-essential \
    python3 \
    python-is-python3 \
    pkg-config \
    libcairo2 \
    libcairo2-dev \
    libgif7 \
    libgif-dev \
    libjpeg-dev \
    libpango1.0 \
    libpango1.0-dev \
    librsvg2-2 \
    librsvg2-dev \
    libgl1-mesa-dev \
    libglew-dev \
    libglu1-mesa-dev \
    libxi-dev \
    xvfb \
    dumb-init \
  && rm -rf /var/lib/apt/lists/* /var/cache/apt/*

WORKDIR /app

# Copy all files
COPY . .

# Install dependencies
RUN npm install --no-fund --no-audit

# Build TypeScript
RUN npm run build

# Ensure npm link works
RUN npm link || true

EXPOSE 5000

ENTRYPOINT ["/usr/bin/dumb-init", "--", "xvfb-run", "--server-args", "-screen 0 1280x1024x24 -ac"]
CMD [ "npm", "run", "dev" ]
