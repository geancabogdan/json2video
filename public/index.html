<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Editly - Video Editor</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
        'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
        sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #333;
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    header h1 {
      color: #667eea;
      margin-bottom: 5px;
      font-size: 28px;
    }

    header p {
      color: #666;
      font-size: 14px;
    }

    .layout {
      display: grid;
      grid-template-columns: 1fr 2fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .panel {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      max-height: 600px;
      overflow-y: auto;
    }

    .panel-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 15px;
      color: #333;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      margin-bottom: 5px;
      color: #555;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    input[type="text"],
    input[type="number"],
    input[type="file"],
    select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      font-family: inherit;
      transition: all 0.2s;
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    input[type="file"]:focus,
    select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s;
      width: 100%;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .button-secondary {
      background: #f0f0f0;
      color: #333;
      margin-top: 8px;
    }

    .button-secondary:hover {
      background: #e0e0e0;
      box-shadow: none;
    }

    .button-danger {
      background: #e74c3c;
      font-size: 12px;
      padding: 6px 12px;
      width: auto;
    }

    .button-success {
      background: #27ae60;
    }

    .clip-item {
      background: #f8f8f8;
      border: 1px solid #e0e0e0;
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 10px;
      font-size: 12px;
    }

    .clip-item-title {
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
    }

    .clip-item-meta {
      color: #999;
      font-size: 11px;
    }

    .clip-item-actions {
      display: flex;
      gap: 5px;
      margin-top: 8px;
    }

    .clip-item-actions button {
      flex: 1;
      padding: 4px;
      font-size: 11px;
    }

    .layer-item {
      background: #fff;
      border-left: 3px solid #667eea;
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 2px;
      font-size: 12px;
    }

    .layer-type {
      display: inline-block;
      background: #667eea;
      color: white;
      padding: 2px 6px;
      border-radius: 3px;
      font-weight: 600;
      font-size: 10px;
      margin-right: 5px;
    }

    .preview-panel {
      background: #1a1a1a;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: #999;
      min-height: 400px;
    }

    .preview-panel.rendering {
      background: #1a1a1a;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .preview-content {
      text-align: center;
    }

    .preview-content video {
      width: 100%;
      height: auto;
      border-radius: 4px;
      max-height: 500px;
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      background: #e0e0e0;
      border-radius: 3px;
      overflow: hidden;
      margin: 10px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      transition: width 0.3s ease;
    }

    .status-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 3px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      margin-bottom: 10px;
    }

    .status-processing {
      background: #f39c12;
      color: white;
    }

    .status-completed {
      background: #27ae60;
      color: white;
    }

    .status-error {
      background: #e74c3c;
      color: white;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      border-bottom: 1px solid #e0e0e0;
    }

    .tab {
      background: none;
      border: none;
      padding: 10px 15px;
      cursor: pointer;
      color: #999;
      font-weight: 600;
      border-bottom: 3px solid transparent;
      margin-bottom: -1px;
      transition: all 0.2s;
      width: auto;
    }

    .tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .error-message {
      background: #fadbd8;
      border-left: 4px solid #e74c3c;
      color: #c0392b;
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 10px;
      font-size: 13px;
    }

    .success-message {
      background: #d5f4e6;
      border-left: 4px solid #27ae60;
      color: #16a085;
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 10px;
      font-size: 13px;
    }

    .spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 3px solid white;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .empty-state {
      text-align: center;
      padding: 30px 20px;
      color: #999;
    }

    .empty-state-icon {
      font-size: 40px;
      margin-bottom: 10px;
    }

    .job-item {
      background: #f8f8f8;
      border: 1px solid #e0e0e0;
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 10px;
      font-size: 12px;
    }

    .job-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .job-item-id {
      font-family: monospace;
      font-size: 11px;
      color: #666;
    }

    .job-item-actions {
      display: flex;
      gap: 5px;
    }

    .job-item-actions button {
      padding: 4px 8px;
      font-size: 11px;
      width: auto;
    }

    @media (max-width: 1200px) {
      .layout {
        grid-template-columns: 1fr;
      }

      .panel {
        max-height: none;
      }
    }

    .code-editor {
      background: #f5f5f5;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 10px;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 12px;
      line-height: 1.5;
      overflow-x: auto;
    }

    textarea {
      width: 100%;
      min-height: 200px;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 12px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      resize: vertical;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    function EditlyApp() {
      const [clips, setClips] = useState([]);
      const [currentClip, setCurrentClip] = useState(null);
      const [videoTitle, setVideoTitle] = useState('My Video');
      const [width, setWidth] = useState(1280);
      const [height, setHeight] = useState(720);
      const [fps, setFps] = useState(30);
      const [jobs, setJobs] = useState([]);
      const [currentJobId, setCurrentJobId] = useState(null);
      const [isRendering, setIsRendering] = useState(false);
      const [error, setError] = useState(null);
      const [success, setSuccess] = useState(null);
      const [activeTab, setActiveTab] = useState('editor');
      const [jsonInput, setJsonInput] = useState('');
      const fileInputRef = useRef(null);

      // Load jobs from API
      useEffect(() => {
        fetchJobs();
        const interval = setInterval(fetchJobs, 2000);
        return () => clearInterval(interval);
      }, []);

      async function fetchJobs() {
        try {
          const response = await fetch('/api/jobs');
          const data = await response.json();
          setJobs(data);
        } catch (err) {
          console.error('Error fetching jobs:', err);
        }
      }

      function addClip() {
        const newClip = {
          id: Date.now(),
          duration: 4,
          transition: { name: 'fade', duration: 0.5 },
          layers: [{ type: 'fill-color', color: '#667eea' }],
        };
        setClips([...clips, newClip]);
        setCurrentClip(newClip.id);
        clearMessages();
      }

      function removeClip(id) {
        const filtered = clips.filter(c => c.id !== id);
        setClips(filtered);
        if (currentClip === id) {
          setCurrentClip(filtered[0]?.id || null);
        }
      }

      function updateClip(id, updates) {
        setClips(clips.map(c => c.id === id ? { ...c, ...updates } : c));
        clearMessages();
      }

      async function handleFileUpload(event, clipId) {
        const file = event.target.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('file', file);

        try {
          const response = await fetch('/api/upload', { method: 'POST', body: formData });
          const data = await response.json();

          if (response.ok) {
            const clip = clips.find(c => c.id === clipId);
            if (clip) {
              const fileType = file.type.startsWith('image') ? 'image' : 'video';
              const layer = {
                type: fileType,
                path: data.path,
              };
              updateClip(clipId, { layers: [layer] });
              setSuccess(`File "${data.originalName}" uploaded successfully`);
            }
          } else {
            setError(data.error || 'Upload failed');
          }
        } catch (err) {
          setError(`Upload error: ${err.message}`);
        }
      }

      async function handleRender() {
        if (clips.length === 0) {
          setError('Please add at least one clip');
          return;
        }

        const spec = {
          clips: clips.map(c => ({
            duration: c.duration,
            layers: c.layers,
            transition: c.transition,
          })),
          outPath: `./outputs/${videoTitle.replace(/\s+/g, '-')}.mp4`,
          width: parseInt(width),
          height: parseInt(height),
          fps: parseInt(fps),
        };

        setIsRendering(true);
        setError(null);

        try {
          const response = await fetch('/api/render', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(spec),
          });
          const data = await response.json();

          if (response.ok) {
            setCurrentJobId(data.jobId);
            setSuccess('Render job submitted! Monitoring progress...');
          } else {
            setError(data.error || 'Render failed');
          }
        } catch (err) {
          setError(`Render error: ${err.message}`);
        } finally {
          setIsRendering(false);
        }
      }

      async function handleDownload(jobId) {
        window.location.href = `/api/render/${jobId}/download`;
      }

      function clearMessages() {
        setError(null);
        setSuccess(null);
      }

      const currentJobStatus = currentJobId ? jobs.find(j => j.id === currentJobId) : null;

      return (
        <div className="container">
          <header>
            <h1>üé¨ Editly Web Editor</h1>
            <p>Create videos with code. No GUI designers needed.</p>
          </header>

          <div className="layout">
            {/* Left Panel - Clips */}
            <div className="panel">
              <div className="panel-title">Clips</div>
              {clips.length === 0 ? (
                <div className="empty-state">
                  <div className="empty-state-icon">üìπ</div>
                  <p>No clips yet. Create your first one!</p>
                </div>
              ) : (
                clips.map(clip => (
                  <div
                    key={clip.id}
                    className={`clip-item ${currentClip === clip.id ? 'active' : ''}`}
                    onClick={() => setCurrentClip(clip.id)}
                    style={{
                      border: currentClip === clip.id ? '2px solid #667eea' : '',
                      cursor: 'pointer',
                    }}
                  >
                    <div className="clip-item-title">
                      Clip {clips.indexOf(clip) + 1}
                    </div>
                    <div className="clip-item-meta">
                      Duration: {clip.duration}s
                    </div>
                    <div className="clip-item-meta">
                      Layers: {clip.layers.length}
                    </div>
                    {clip.layers.map((layer, i) => (
                      <div key={i} className="layer-item">
                        <span className="layer-type">{layer.type}</span>
                        {layer.text && <span>{layer.text}</span>}
                        {layer.path && <span>{layer.path.split('/').pop()}</span>}
                      </div>
                    ))}
                    <div className="clip-item-actions">
                      <button
                        className="button-secondary"
                        onClick={(e) => {
                          e.stopPropagation();
                          removeClip(clip.id);
                        }}
                      >
                        Remove
                      </button>
                    </div>
                  </div>
                ))
              )}
              <button onClick={addClip} style={{ marginTop: '10px' }}>
                + Add Clip
              </button>
            </div>

            {/* Center Panel - Editor */}
            <div className="panel">
              <div className="tabs">
                <button
                  className={`tab ${activeTab === 'editor' ? 'active' : ''}`}
                  onClick={() => setActiveTab('editor')}
                >
                  Visual Editor
                </button>
                <button
                  className={`tab ${activeTab === 'preview' ? 'active' : ''}`}
                  onClick={() => setActiveTab('preview')}
                >
                  Preview
                </button>
              </div>

              <div className={`tab-content ${activeTab === 'editor' ? 'active' : ''}`}>
                <div className="panel-title">Video Settings</div>

                {error && <div className="error-message">‚ùå {error}</div>}
                {success && <div className="success-message">‚úÖ {success}</div>}

                <div className="form-group">
                  <label>Video Title</label>
                  <input
                    type="text"
                    value={videoTitle}
                    onChange={(e) => setVideoTitle(e.target.value)}
                    placeholder="My Video"
                  />
                </div>

                <div className="form-group">
                  <label>Width (px)</label>
                  <input
                    type="number"
                    value={width}
                    onChange={(e) => setWidth(e.target.value)}
                  />
                </div>

                <div className="form-group">
                  <label>Height (px)</label>
                  <input
                    type="number"
                    value={height}
                    onChange={(e) => setHeight(e.target.value)}
                  />
                </div>

                <div className="form-group">
                  <label>FPS</label>
                  <input
                    type="number"
                    value={fps}
                    onChange={(e) => setFps(e.target.value)}
                  />
                </div>

                {currentClip && (
                  <>
                    <div className="panel-title" style={{ marginTop: '20px' }}>
                      Edit Clip
                    </div>

                    {(() => {
                      const clip = clips.find(c => c.id === currentClip);
                      return clip ? (
                        <>
                          <div className="form-group">
                            <label>Duration (seconds)</label>
                            <input
                              type="number"
                              value={clip.duration}
                              onChange={(e) =>
                                updateClip(clip.id, { duration: parseFloat(e.target.value) })
                              }
                            />
                          </div>

                          <div className="form-group">
                            <label>Transition Type</label>
                            <select
                              value={clip.transition?.name || 'fade'}
                              onChange={(e) =>
                                updateClip(clip.id, {
                                  transition: { ...clip.transition, name: e.target.value },
                                })
                              }
                            >
                              <option value="random">Random</option>
                              <option value="fade">Fade</option>
                              <option value="CircleCrop">Circle Crop</option>
                              <option value="circleopen">Circle Open</option>
                              <option value="CrossZoom">Cross Zoom</option>
                              <option value="Directional">Directional</option>
                              <option value="wipeRight">Wipe Right</option>
                              <option value="wipeLeft">Wipe Left</option>
                              <option value="wipeDown">Wipe Down</option>
                              <option value="wipeUp">Wipe Up</option>
                              <option value="WaterDrop">Water Drop</option>
                              <option value="Bounce">Bounce</option>
                              <option value="Swirl">Swirl</option>
                              <option value="Mosaic">Mosaic</option>
                              <option value="burn">Burn</option>
                              <option value="Radial">Radial</option>
                              <option value="SimpleZoom">Simple Zoom</option>
                            </select>
                          </div>

                          <div className="form-group">
                            <label>Transition Duration (seconds)</label>
                            <input
                              type="number"
                              step="0.1"
                              value={clip.transition?.duration || 0.5}
                              onChange={(e) =>
                                updateClip(clip.id, {
                                  transition: { ...clip.transition, duration: parseFloat(e.target.value) },
                                })
                              }
                            />
                          </div>

                          <div className="form-group">
                            <label>Layer Type</label>
                            <select
                              value={clip.layers[0]?.type || 'fill-color'}
                              onChange={(e) => {
                                const newLayer = { type: e.target.value };
                                if (e.target.value === 'fill-color') {
                                  newLayer.color = '#667eea';
                                }
                                updateClip(clip.id, { layers: [newLayer] });
                              }}
                            >
                              <option value="fill-color">Solid Color</option>
                              <option value="video">Video File</option>
                              <option value="image">Image File</option>
                              <option value="title">Title Text</option>
                            </select>
                          </div>

                          {clip.layers[0]?.type === 'fill-color' && (
                            <div className="form-group">
                              <label>Color</label>
                              <input
                                type="text"
                                value={clip.layers[0]?.color || '#667eea'}
                                onChange={(e) =>
                                  updateClip(clip.id, {
                                    layers: [{ type: 'fill-color', color: e.target.value }],
                                  })
                                }
                                placeholder="#667eea"
                              />
                            </div>
                          )}

                          {['video', 'image'].includes(clip.layers[0]?.type) && (
                            <div className="form-group">
                              <label>Upload {clip.layers[0]?.type}</label>
                              <input
                                type="file"
                                accept={clip.layers[0]?.type === 'video' ? 'video/*' : 'image/*'}
                                onChange={(e) => handleFileUpload(e, clip.id)}
                              />
                              {clip.layers[0]?.path && (
                                <div className="clip-item-meta" style={{ marginTop: '8px' }}>
                                  üìé {clip.layers[0]?.path.split('/').pop()}
                                </div>
                              )}
                            </div>
                          )}

                          {clip.layers[0]?.type === 'title' && (
                            <div className="form-group">
                              <label>Title Text</label>
                              <input
                                type="text"
                                value={clip.layers[0]?.text || ''}
                                onChange={(e) =>
                                  updateClip(clip.id, {
                                    layers: [{ type: 'title', text: e.target.value }],
                                  })
                                }
                                placeholder="Enter title text"
                              />
                            </div>
                          )}
                        </>
                      ) : null;
                    })()}
                  </>
                )}

                <button
                  className="button-success"
                  onClick={handleRender}
                  disabled={isRendering || clips.length === 0}
                  style={{ marginTop: '20px' }}
                >
                  {isRendering ? '‚è≥ Rendering...' : '‚ñ∂Ô∏è Render Video'}
                </button>
              </div>

              <div className={`tab-content ${activeTab === 'preview' ? 'active' : ''}`}>
                <div className="preview-panel">
                  {currentJobStatus ? (
                    <div className="preview-content">
                      <div className={`status-badge status-${currentJobStatus.status}`}>
                        {currentJobStatus.status}
                      </div>
                      {currentJobStatus.status === 'processing' && (
                        <>
                          <div className="spinner"></div>
                          <p style={{ marginTop: '15px', color: '#999' }}>
                            Rendering your video...
                          </p>
                          <div className="progress-bar">
                            <div
                              className="progress-fill"
                              style={{
                                width: `${Math.min((currentJobStatus.progress || 0) * 100, 100)}%`,
                              }}
                            ></div>
                          </div>
                        </>
                      )}
                      {currentJobStatus.status === 'completed' && (
                        <>
                          <p style={{ marginBottom: '20px', color: '#27ae60' }}>
                            ‚úÖ Video rendered successfully!
                          </p>
                          <button
                            className="button-success"
                            onClick={() => handleDownload(currentJobStatus.id)}
                          >
                            üì• Download Video
                          </button>
                        </>
                      )}
                      {currentJobStatus.status === 'error' && (
                        <p style={{ marginTop: '15px', color: '#e74c3c' }}>
                          ‚ùå Error: {currentJobStatus.error}
                        </p>
                      )}
                    </div>
                  ) : (
                    <div className="empty-state">
                      <div className="empty-state-icon">üëÅÔ∏è</div>
                      <p>No video rendering yet.</p>
                      <p style={{ fontSize: '12px', marginTop: '10px', color: '#999' }}>
                        Click "Render Video" to get started
                      </p>
                    </div>
                  )}
                </div>
              </div>
            </div>

            {/* Right Panel - Jobs */}
            <div className="panel">
              <div className="panel-title">Render Jobs</div>
              {jobs.length === 0 ? (
                <div className="empty-state" style={{ padding: '20px 10px' }}>
                  <div className="empty-state-icon" style={{ fontSize: '24px' }}>
                    üìã
                  </div>
                  <p>No jobs yet</p>
                </div>
              ) : (
                jobs
                  .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                  .slice(0, 10)
                  .map(job => (
                    <div key={job.id} className="job-item">
                      <div className="job-item-header">
                        <div className={`status-badge status-${job.status}`}>
                          {job.status}
                        </div>
                      </div>
                      <div className="job-item-id">{job.id.slice(0, 8)}...</div>
                      {job.status === 'processing' && (
                        <div className="progress-bar">
                          <div
                            className="progress-fill"
                            style={{
                              width: `${Math.min((job.progress || 0) * 100, 100)}%`,
                            }}
                          ></div>
                        </div>
                      )}
                      {job.status === 'completed' && (
                        <div className="job-item-actions">
                          <button
                            className="button-success"
                            onClick={() => handleDownload(job.id)}
                          >
                            Download
                          </button>
                        </div>
                      )}
                      {job.status === 'error' && (
                        <div
                          style={{
                            fontSize: '11px',
                            color: '#e74c3c',
                            marginTop: '5px',
                          }}
                        >
                          {job.error}
                        </div>
                      )}
                    </div>
                  ))
              )}
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<EditlyApp />);
  </script>
</body>
</html>
